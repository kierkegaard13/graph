var ui=function(){"use strict";var e=$(".graph_cont").width(),t=$(".graph_cont").height(),n=20,r=25,i=d3.scale.category20(),s=1e3,o,u,a=-1,f="";jQuery.expr[":"].icontains=function(e,t,n){return jQuery(e).text().toUpperCase().indexOf(n[3].toUpperCase())>=0};var l=function(s){function L(e){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function A(e){d3.select(this).classed("dragging",!1)}var o,u,a,f,l,c,h,p,d,v,m,g,y,b;b=0,m=0,v=0,g=-1,y=-1;var w=[],E=[],S=[],x=[],T={},N=this,C=function(){d.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")},k=d3.behavior.zoom().scaleExtent([.1,2]).on("zoom",C);this.inspectNodes=function(){return S},this.inspectLinks=function(){return x},this.constructForceLayout=function(){$("svg").remove();var n=Math.sqrt(S.length/(e*t));h=d3.layout.force().charge(function(e){var t=-3e3*(g/e.edges)-200;return t}).linkDistance(function(e){var t,n;return t=(e.source.edges/g+e.target.edges/g)/2,n=.9/(y/g),t*=n,t>1&&(t=1),80*S.node_degree*(1.2-t)}).linkStrength(.8).size([e,t]).links(x).nodes(S).on("tick",this.tick),p=d3.select(".graph_cont").append("svg").attr("width",e).attr("height",t).call(k).on("dblclick.zoom",null),d=p.append("g"),o=h.drag().on("dragstart",L).on("dragend",A)},this.clearNodes=function(){S=[],x=[],m=0,v=0,g=-1,y=-1,b=0},this.refreshNodes=function(){$.each(S,function(e,t){t.fixed=!0})},this.neighboring=function(e,t){return e===t||T[e+"-"+t]},this.countNodes=function(){m=S.length,v=x.length,$.each(S,function(e,t){E[t.id].length>0&&(g===-1||E[t.id].length<g)&&(g=E[t.id].length),E[t.id].length>0&&(y===-1||E[t.id].length>y)&&(y=E[t.id].length),b+=E[t.id].length,t.edges=E[t.id].length}),b/=m,S.node_degree=b},this.buildLinks=function(e){var t,n;t=parseInt($("#min_w").val()),n=parseInt($("#max_w").val()),E=[];for(var r=0;r<S.length;r++)E.push([]);switch(e){case"tree":var i,s,o=[],u=[];for(var r=1;r<S.length;r++)o.push(S[r]);u.push(S[0]);while(o.length!==0){i=Math.floor(Math.random()*5+1);for(var r=0;r<i;r++){if(!(o.length>0))break;s=Math.floor(Math.random()*(o.length-1)),x.push({source:S[u[0].id],target:S[o[s].id],type:0,weight:Math.floor(Math.random()*n+t)}),E[u[0].id].push(o[s].id),E[o[s].id].push(u[0].id),u.push(o[s]),o.splice(s,1)}u.shift()}break;case"btree":var s,o=[],u=[];for(var r=1;r<S.length;r++)o.push(S[r]);u.push(S[0]);while(o.length!==0){for(var r=0;r<2;r++){if(!(o.length>0))break;s=Math.floor(Math.random()*(o.length-1)),x.push({source:S[u[0].id],target:S[o[s].id],type:0,weight:Math.floor(Math.random()*n+t)}),E[u[0].id].push(o[s].id),E[o[s].id].push(u[0].id),u.push(o[s]),o.splice(s,1)}u.shift()}break;case"sparse":var a,s,f,l,c,h,p,o=[],d;p=S.length,h=Math.floor(Math.random()*(p*(p-1)/4-1-p)+p),c=Math.ceil(h/p),a=h%p;for(var r=0;r<S.length;r++)o.push(S[r]);while(o.length!==0){l=Math.floor(Math.random()*(o.length-1)),f=o[l],o.splice(l,1),d=[];for(var r=0;r<p;r++)E[r].indexOf(f.id)===-1&&d.push(S[r]);for(var r=0;r<c;r++){if(!(d.length>0))break;s=Math.floor(Math.random()*(d.length-1)),x.push({source:S[f.id],target:d[s],type:0,weight:Math.floor(Math.random()*n+t)}),E[f.id].push(d[s].id),E[d[s].id].push(f.id),d.splice(s,1),a--,a==0&&(c--,a=h)}}break;case"dense":var a,s,f,l,c,h,p,o=[],d;p=S.length,h=Math.floor(Math.random()*(p*(p-1)/4-1-p)+p+p*(p-1)/4),c=Math.ceil(h/p),a=h%p;for(var r=0;r<p;r++)o.push(S[r]);while(o.length!==0){l=Math.floor(Math.random()*(o.length-1)),f=o[l],o.splice(l,1),d=[];for(var r=0;r<p;r++)E[r].indexOf(f.id)===-1&&d.push(S[r]);for(var r=0;r<c;r++){if(!(d.length>0))break;s=Math.floor(Math.random()*(d.length-1)),x.push({source:S[f.id],target:d[s],type:0,weight:Math.floor(Math.random()*n+t)}),E[f.id].push(d[s].id),E[d[s].id].push(f.id),d.splice(s,1),a--,a==0&&(c--,a=h)}}break;case"full":for(var r=0;r<S.length;r++)for(var v=r+1;v<S.length;v++)x.push({source:S[r],target:S[v],type:0,weight:Math.floor(Math.random()*n+t)}),E[r].push(v),E[v].push(r);break;case"custom":var m,g=parseFloat($("#prob").val());for(var r=0;r<S.length;r++)for(var v=r+1;v<S.length;v++)m=Math.random()<g,m===!0&&(x.push({source:S[r],target:S[v],type:0,weight:Math.floor(Math.random()*n+t)}),E[r].push(v),E[v].push(r));break;default:}$("#graph_data").html(""),$("#graph_data").append("<div>"+S.length+" "+x.length+"</div>"),T={},this.countNodes();for(var r=0;r<x.length;r++)T[x[r].source.id+"-"+x[r].target.id]=1,T[x[r].target.id+"-"+x[r].source.id]=1,$("#graph_data").append("<div>"+x[r].source.id+" "+x[r].target.id+" "+x[r].weight+"</div>")},this.buildNodes=function(n,r){var i;if(r==="tree"||r==="btree")n[0].group=1;this.clearNodes();for(var s=0;s<n.length;s++){var o=n[s];o.x=e/2,o.y=t/2,S.push(o)}this.buildLinks(r)},this.buildGraphFromInput=function(){var n,r,i,s=$("#graph_data").html();s=s.replace(/<\/div>/g,"").split(/<div[\s\w="-:;]*>/),s[0]===""&&s.splice(0,1),n=parseInt(s[0].split(" ")[0]),r=parseInt(s[0].split(" ")[1]),E=[];for(var o=0;o<n;o++)E.push([]);this.clearNodes();for(var o=0;o<n;o++)S.push({id:o,x:e/2,y:t/2});for(var o=1;o<=r;o++)s[o].length>0&&(s[o].trim(),i=s[o].split(" "),i.length<3?i={source:parseInt(i[0]),target:parseInt(i[1]),weight:undefined}:i={source:parseInt(i[0]),target:parseInt(i[1]),weight:parseFloat(i[2])},E[i.source].push(i.target),E[i.target].push(i.source),x.push({source:S[i.source],target:S[i.target],type:0,weight:i.weight}),T={},T[i.source+"-"+i.target]=1,T[i.target+"-"+i.source]=1);this.countNodes()},this.findEdge=function(e,t){var n=null;e=parseInt(e),t=parseInt(t);for(var r=0;r<x.length;r++){if(x[r].source.id===e&&x[r].target.id===t)return n=x[r],{dom:$("#link_"+e+"_"+t),item:n};if(x[r].source.id===t&&x[r].target.id===e)return n=x[r],{dom:$("#link_"+t+"_"+e),item:n}}return null},this.dullEdge=function(e,t){var n=$("#link_"+e+"_"+t);n.length===0&&(n=$("#link_"+t+"_"+e)),n.find(".link-line").attr("opacity",.2),n.find(".link-line").attr("dulled",1)},this.highlightEdge=function(e,t){var n=$("#link_"+e+"_"+t);n.length===0&&(n=$("#link_"+t+"_"+e)),n.find(".link-line").attr("opacity",1),n.find(".link-line").attr("dulled",""),n.find(".link-line").css("stroke","red")},this.highlightEdges=function(e){var t;if(e.length===1)for(var n=0;n<x.length;n++)t=this.findEdge(x[n].source.id,x[n].target.id),t&&(t.dom.find(".link-line").css("stroke",i(t.item.type)),t.dom.find(".link-line").attr("opacity",1),t.dom.find(".link-line").attr("dulled",""));else for(var n=0;n<x.length;n++)this.dullEdge(x[n].source.id,x[n].target.id);for(var n=w.length-1;n>=0;n--)t=this.findEdge(w[n].source,w[n].target),t&&t.dom.find(".link-line").css("stroke",i(t.item.type)),w.pop();for(var n=0;n<e.length;n++)this.highlightEdge(e[n].source,e[n].target),w.push(e[n])},this.algo=function(e){var t=this,n=$("#graph_data").html().replace(/<\/div>/g,"").replace(/\n/g,"").split(/<div[\s\w="-:;]*>/);e==="dijkstra"&&(n[0]!==""?n[0]=n[0]+" "+$("#start").val()+" "+$("#end").val():n[1]=n[1]+" "+$("#start").val()+" "+$("#end").val()),n={name:e,data:n},$.ajax({url:window.location.href.split("/")[0]+"/algo/",data:n}).done(function(n){var r,i="<div>",s="</div>";r=n,n=n.join("</div><div>"),i=i.concat(n,s);for(var o=0;o<r.length;o++)r[o].trim(),r[o]={source:r[o].split(" ")[0],target:r[o].split(" ")[1]};e!=="dijkstra"&&t.highlightEdges(r),$("#highlight_edges").html(i)})},this.networkGraph=function(e){var t=this,n;n={name:e},$.ajax({url:window.location.href.split("/")[0]+"/graph/",data:n}).done(function(e){var t,n="<div>",r="</div>";t=e,e=e.join("</div><div>"),n=n.concat(e,r),$("#graph_data").html(n)})},this.refreshGraph=function(){this.constructForceLayout(),u=d.selectAll(".link").data(h.links()).enter().append("g").attr("class","link").attr("id",function(e){return"link_"+e.source.id+"_"+e.target.id}).append("line").attr("class","link-line").attr("stroke-width",4).style("stroke",function(e){return i(e.type)}),f=d.selectAll(".link").append("text").attr("class","link-label").attr("font-family","Arial, Helvetica, sans-serif").style("font","normal 18px Arial").style("stroke","white").style("stroke-width","2.5").style("opacity",".9").attr("dy",".35em").attr("text-anchor","middle").text(function(e){return typeof e.weight===undefined?"":e.weight}),a=d.selectAll(".link").append("text").attr("class","link-label").attr("font-family","Arial, Helvetica, sans-serif").attr("fill","Black").style("font","normal 18px Arial").attr("dy",".35em").attr("text-anchor","middle").text(function(e){return typeof e.weight===undefined?"":e.weight}),c=d.selectAll(".node").data(h.nodes()).enter().append("g").attr("class","node").on("mouseover",function(e){d.selectAll("#node_"+e.id).transition().duration(500).attr("r",r),d.selectAll(".node").transition().duration(500).attr("opacity",function(t){return N.neighboring(e.id,t.id)?1:.2}),d.selectAll(".link-line").transition().duration(500).attr("opacity",function(t){return t.source.id==e.id||t.target.id==e.id?1:.2}),d.selectAll(".link-label").transition().duration(500).attr("display",function(t){return t.source.id==e.id||t.target.id==e.id?"":"none"})}).on("mouseout",function(e){d.selectAll("#node_"+e.id).transition().duration(500).attr("r",n),d.selectAll(".node").transition().duration(500).attr("opacity",1),d.selectAll(".link-line").transition().duration(500).attr("opacity",function(e){var t=N.findEdge(e.source.id,e.target.id).dom.find(".link-line");return t.attr("dulled")!=1?1:.2}),d.selectAll(".link-label").transition().duration(500).attr("display","")}).call(o).append("circle").attr("class","node-circle").attr("r",n).attr("id",function(e){return"node_"+e.id}).style("fill",function(e){return e.group===1?"#024dd9":"#6c28f7"}),l=d.selectAll(".node").append("text").attr("class","node-label").attr("font-family","Arial, Helvetica, sans-serif").attr("fill","white").style("font","normal 18px Arial").attr("dy",".35em").attr("text-anchor","middle").text(function(e){return e.id}),h.start()},this.tick=function(e){d.selectAll(".node-circle").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),d.selectAll(".link-line").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),l.attr("x",function(e){return e.x}).attr("y",function(e){return e.y}),a.attr("x",function(e){return(e.source.x+e.target.x)/2+15}).attr("y",function(e){return(e.source.y+e.target.y)/2+15}),f.attr("x",function(e){return(e.source.x+e.target.x)/2+15}).attr("y",function(e){return(e.source.y+e.target.y)/2+15})}},c=new l;return $(document).on("ready",function(){var e=[];for(var t=0;t<20;t++)e.push({id:t});$("#graph_type").text("Tree"),a=0,c.buildNodes(e,"tree"),c.refreshGraph()}),$("#graph_build").on("click",function(){var e=$(".graph_type_option").eq(a);console.log(a,e);if(e.hasClass("js_generated")){console.log("hihi");var t,n,r=[];t=$("#num_nodes").val(),n=e.attr("value");for(var i=0;i<t;i++)r.push({id:i});c.buildNodes(r,n)}else c.networkGraph(e.attr("value"))}),$("#graph_visualize").on("click",function(){c.buildGraphFromInput(),c.inspectLinks().length>s?$("#warning_modal").modal("show"):c.refreshGraph()}),$("#continue_visualizing").on("click",function(){c.refreshGraph()}),$("#graph_highlight").on("click",function(){var e;e=$("#highlight_edges").html().replace(/<\/div>/g,"").replace(/\n/g,"").split(/<div[\s\w="-:;]*>/);for(var t=0;t<e.length;t++)e[t].trim(),e[t]={source:e[t].split(" ")[0],target:e[t].split(" ")[1]};c.highlightEdges(e)}),$("#graph_run").on("click",function(){var e=$("#graph_algo").val();c.algo(e)}),$("#graph_algo").on("change",function(){$(this).val()==="dijkstra"?$("#start").closest(".row").show():$("#start").closest(".row").hide()}),$("#graph_type").on("focus",function(){$("#graph_type_options").show(),f=$("#graph_type").text(),$("#graph_type").text(""),$('.graph_type_option:icontains("'+$(this).text().trim()+'")').show()}),$("#graph_type").on("blur",function(){$("#graph_type").text()===""&&$("#graph_type").text(f),$("#graph_type_options").hide()}),$(".graph_type_option").on("mousedown",function(e){$("#graph_type").blur(),$("#graph_type").text($(this).text()),a=$(this).index(),$(this).attr("value")==="input"?$(".opt").hide():$(this).attr("value")==="custom"?($(".opt").show(),$(".custom_hide").hide(),$(".custom_opt").show()):$(this).hasClass("num_fixed")?($(".opt").show(),$(".nx_opt").hide(),$(".num_opt").hide()):($(".opt").show(),$(".custom_hide").show(),$(".custom_opt").hide())}),$("#graph_type").on("keyup",function(e){var t,n;e.keyCode===13?a!==-1&&(n=$(".graph_type_option").eq(a),$("#graph_type").blur(),$("#graph_type").text(n.text()),n.attr("value")==="input"?$(".opt").hide():n.attr("value")==="custom"?($(".opt").show(),$(".custom_hide").hide(),$(".custom_opt").show()):n.hasClass("num_fixed")?($(".opt").show(),$(".nx_opt").hide(),$(".num_opt").hide()):($(".opt").show(),$(".custom_hide").show(),$(".custom_opt").hide())):e.keyCode===38?a=a<1?$(".graph_type_option").length-1:a-1:e.keyCode===40?a=a===$(".graph_type_option").length-1?0:a+1:($(".graph_type_option").hide(),$('.graph_type_option:icontains("'+$(this).text().trim()+'")').show()),t=$("#graph_type_options"),n=$(".graph_type_option").eq(a),$(".graph_type_option").css("background-color","#fff"),n.css("background-color","#ddd"),t.height()<n.position().top+n.outerHeight()&&t.scrollTop(t.scrollTop()+(n.position().top+n.outerHeight()-t.height())),n.position().top<0&&t.scrollTop(t.scrollTop()+n.position().top)}),$(".collapse_toggle").on("click",function(){return!1}),$(".collapse_cont").on("click",function(){$($(this).find("a").attr("href")).collapse("toggle"),$(this).hasClass("dropup")?$(this).removeClass("dropup"):$(this).addClass("dropup")}),c}()